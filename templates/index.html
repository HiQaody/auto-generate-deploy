<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de fichiers backend/front-end</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'slide-in': 'slideIn 0.6s ease-out',
                        'slide-in-row': 'slideInRow 0.3s ease-out',
                        'pulse-custom': 'pulseCustom 4s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.4s ease-out',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': {opacity: '0', transform: 'translateY(30px)'},
                            '100%': {opacity: '1', transform: 'translateY(0)'}
                        },
                        slideInRow: {
                            '0%': {opacity: '0', transform: 'translateX(-20px)'},
                            '100%': {opacity: '1', transform: 'translateX(0)'}
                        },
                        pulseCustom: {
                            '0%, 100%': {transform: 'scale(1)', opacity: '0.5'},
                            '50%': {transform: 'scale(1.1)', opacity: '0.8'}
                        },
                        float: {
                            '0%, 100%': {transform: 'translateY(0px)'},
                            '50%': {transform: 'translateY(-10px)'}
                        },
                        fadeIn: {
                            '0%': {opacity: '0'},
                            '100%': {opacity: '1'}
                        }
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-5 text-gray-800">
<div class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-6">
    <!-- Main Form Container -->
    <div class="lg:col-span-2 bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl overflow-hidden animate-slide-in">
        <!-- Header -->
        <div class="relative bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 text-center overflow-hidden">
            <div class="absolute inset-0 bg-gradient-radial from-white/10 to-transparent opacity-50 animate-pulse-custom"></div>
            <div class="relative z-10">
                <h1 class="text-4xl font-bold mb-3 animate-float">üöÄ G√©n√©rateur Backend / Front-end</h1>
                <p class="text-lg opacity-90 mb-4">Cr√©ez vos fichiers Dockerfile, YAML et Jenkinsfile en quelques clics</p>
                <div class="flex justify-center gap-2 flex-wrap">
                    <span class="bg-white/20 px-4 py-2 rounded-full text-sm backdrop-blur-sm">Docker</span>
                    <span class="bg-white/20 px-4 py-2 rounded-full text-sm backdrop-blur-sm">Kubernetes</span>
                    <span class="bg-white/20 px-4 py-2 rounded-full text-sm backdrop-blur-sm">Jenkins</span>
                </div>
            </div>
        </div>

        <!-- Form -->
        <div class="p-10">
            <form id="genForm" class="space-y-8">
                <!-- Grid Layout for App Info -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="group">
                        <label class="block mb-3 font-semibold text-gray-700 text-sm flex items-center gap-2">
                            <span class="text-lg">üì¶</span>
                            Nom de l'application
                        </label>
                        <input
                                type="text"
                                name="app_name"
                                class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-lg focus:-translate-y-1 hover:-translate-y-0.5"
                                placeholder="mon-app-backend"
                                required
                        >
                    </div>
                    <div class="group">
                        <label class="block mb-3 font-semibold text-gray-700 text-sm flex items-center gap-2">
                            <span class="text-lg">üîå</span>
                            Port du container
                        </label>
                        <input
                                type="number"
                                name="port"
                                class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-lg focus:-translate-y-1 hover:-translate-y-0.5"
                                value="3000"
                                placeholder="3000"
                                required
                        >
                    </div>
                </div>

                <div class="group">
                    <label class="block mb-3 font-semibold text-gray-700 text-sm flex items-center gap-2">
                        <span class="text-lg">üåê</span>
                        NodePort Kubernetes
                    </label>
                    <input
                            type="number"
                            name="node_port"
                            class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-lg focus:-translate-y-1 hover:-translate-y-0.5"
                            value="30130"
                            placeholder="30130"
                            required
                    >
                </div>

                <!-- Project Type Selection -->
                <div class="group">
                    <label class="block mb-3 font-semibold text-gray-700 text-sm flex items-center gap-2">
                        <span class="text-lg">üõ†Ô∏è</span>
                        Type de projet
                    </label>
                    <select
                            name="project_type"
                            class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-lg focus:-translate-y-1 hover:-translate-y-0.5"
                            required
                    >
                        <option value="backend" selected>Backend</option>
                        <option value="frontend">Frontend</option>
                    </select>
                </div>

                <!-- Simple  ou avec kubernetes -->
                <div class="group">
                    <label class="block mb-3 font-semibold text-gray-700 text-sm flex items-center gap-2">
                        <span class="text-lg">üõ†Ô∏è</span>
                        Simple  ou avec kubernetes
                    </label>
                    <select
                            id="simple_or_k8s"
                            name="simple_or_k8s"
                            class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-indigo-500 focus:bg-white focus:shadow-lg focus:-translate-y-1 hover:-translate-y-0.5"
                            required
                    >
                        <option value="false" selected>Kubernetes</option>
                        <option value="true">Sans K8s</option>
                    </select>
                </div>

                <!-- Environment Variables Section -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 border border-gray-200 shadow-inner">
                    <h3 class="text-gray-800 mb-6 text-xl font-semibold flex items-center gap-3">
                        <span class="text-2xl">üîß</span>
                        Variables d'environnement & Credentials Jenkins
                    </h3>
                    <div class="mb-6 text-gray-600 text-sm bg-blue-100 p-4 rounded-lg border-l-4 border-blue-500">
                        <strong class="text-blue-800">üí° Info :</strong> Configurez vos variables avec leurs credentials
                        Jenkins pour une int√©gration automatique.<br>
                        <span class="text-blue-800 font-medium">Valeur :</span> si vide, la valeur sera inject√©e par
                        Jenkins, sinon utilis√©e telle quelle.
                    </div>

                    <div id="envContainer" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end animate-slide-in-row">
                            <input
                                    name="env_name"
                                    type="text"
                                    class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
                                    placeholder="DB_HOST"
                                    required
                            >
                            <input
                                    name="env_value"
                                    type="text"
                                    class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
                                    placeholder="${DB_HOST}"
                            >
                            <input
                                    name="secret_id"
                                    type="text"
                                    class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
                                    placeholder="POSTGRES_HOST_ID"
                            >
                            <button
                                    type="button"
                                    class="w-10 h-10 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-semibold cursor-pointer transition-all duration-300 flex items-center justify-center shadow-lg hover:scale-105 hover:shadow-xl"
                                    onclick="removeRow(this)"
                                    title="Supprimer"
                            >
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    <button
                            type="button"
                            class="mt-6 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg font-semibold cursor-pointer transition-all duration-300 flex items-center gap-2 shadow-lg hover:-translate-y-1 hover:shadow-xl"
                            onclick="addRow()"
                    >
                        ‚ûï Ajouter une variable
                    </button>
                </div>

                <!-- Submit Button -->
                <button
                        type="submit"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white text-lg font-semibold py-4 px-8 rounded-xl transition-all duration-300 shadow-xl hover:-translate-y-1 hover:shadow-2xl active:translate-y-0 flex items-center justify-center gap-3"
                >
                    üéØ G√©n√©rer les fichiers
                </button>
            </form>

            <!-- Loading -->
            <div id="loading" class="hidden justify-center items-center gap-3 text-indigo-600 font-semibold mt-6">
                <div class="w-5 h-5 border-3 border-gray-200 border-t-indigo-600 rounded-full spinner"></div>
                <span>G√©n√©ration en cours...</span>
            </div>

            <!-- Result -->
            <div id="result" class="mt-8"></div>
        </div>
    </div>

    <!-- Generated Files Sidebar -->
    <div class="lg:col-span-1 bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl overflow-hidden animate-slide-in">
        <!-- Sidebar Header -->
        <div class="bg-gradient-to-br from-emerald-600 to-teal-700 text-white p-6 text-center">
            <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                üìã Fichiers g√©n√©r√©s
            </h2>
            <p class="text-sm opacity-90">Vos archives g√©n√©r√©es</p>
            <button
                    id="refreshBtn"
                    onclick="loadFilesFromServer()"
                    class="mt-3 bg-white/20 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-300 hover:bg-white/30 flex items-center gap-2 mx-auto"
            >
                üîÑ Actualiser
            </button>
        </div>

        <!-- Files List -->
        <div class="p-6">
            <div id="generatedFiles" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <span class="text-4xl">üìÅ</span>
                    <p class="mt-2 text-sm">Aucun fichier g√©n√©r√©</p>
                </div>
            </div>

            <!-- Clear All Button -->
            <button
                    id="clearAllBtn"
                    onclick="clearAllFiles()"
                    class="hidden w-full mt-4 bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:-translate-y-1 hover:shadow-xl"
            >
                üóëÔ∏è Tout supprimer
            </button>
        </div>
    </div>
</div>

<script>
    // Gestion des fichiers g√©n√©r√©s
    let generatedFilesList = [];

    function addRow() {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 items-end animate-slide-in-row';
        row.innerHTML = `
        <input
          name="env_name"
          type="text"
          class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
          placeholder="Nom variable (ex: DB_HOST)"
          required
        >
        <input
          name="env_value"
          type="text"
          class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
          placeholder="Valeur par d√©faut"
        >
        <input
          name="secret_id"
          type="text"
          class="p-3 border-2 border-gray-200 rounded-lg text-sm transition-all duration-300 bg-white focus:outline-none focus:border-indigo-500 focus:shadow-md"
          placeholder="Jenkins Credential ID"
        >
        <button
          type="button"
          class="w-10 h-10 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-semibold cursor-pointer transition-all duration-300 flex items-center justify-center shadow-lg hover:scale-105 hover:shadow-xl"
          onclick="removeRow(this)"
          title="Supprimer"
        >
          üóëÔ∏è
        </button>
      `;
        document.getElementById('envContainer').appendChild(row);

        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';
        setTimeout(() => {
            row.style.transition = 'all 0.3s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateX(0)';
        }, 10);
    }

    function removeRow(btn) {
        const row = btn.parentElement;
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(20px)';
        setTimeout(() => row.remove(), 300);
    }

    // Fonction pour charger les fichiers depuis le serveur
    async function loadFilesFromServer() {
        try {
            const response = await fetch('/list-files');
            const data = await response.json();

            if (data.files) {
                generatedFilesList = data.files.map(file => ({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    type: file.name.includes('frontend') || file.name.includes('front') ? 'frontend' : 'backend',
                    timestamp: new Date(file.created).getTime(),
                    size: file.size
                }));
                updateFilesList();
            }
        } catch (error) {
            console.error('Erreur lors du chargement des fichiers:', error);
        }
    }

    function downloadFile(fileName) {
        // R√©cup√©rer le fichier depuis le serveur
        fetch('/download/' + encodeURIComponent(fileName))
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Fichier non trouv√©');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('Erreur lors du t√©l√©chargement : ' + error.message);
            });
    }

    function removeFile(id) {
        generatedFilesList = generatedFilesList.filter(f => f.id !== id);
        updateFilesList();
    }

    async function clearAllFiles() {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer tous les fichiers g√©n√©r√©s ?')) {
            try {
                const response = await fetch('/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    generatedFilesList = [];
                    updateFilesList();
                    alert('Tous les fichiers ont √©t√© supprim√©s avec succ√®s.');
                } else {
                    alert('Erreur lors de la suppression : ' + data.error);
                }
            } catch (error) {
                alert('Erreur lors de la suppression : ' + error.message);
            }
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateFilesList() {
        const container = document.getElementById('generatedFiles');
        const clearBtn = document.getElementById('clearAllBtn');

        if (generatedFilesList.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <span class="text-4xl">üìÅ</span>
                    <p class="mt-2 text-sm">Aucun fichier g√©n√©r√©</p>
                </div>
            `;
            clearBtn.classList.add('hidden');
        } else {
            container.innerHTML = generatedFilesList.map(file => `
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200 animate-fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${file.type === 'backend' ? '‚öôÔ∏è' : 'üé®'}</span>
                            <h4 class="font-semibold text-gray-800 text-sm truncate">${file.name}</h4>
                        </div>
                        <button
                            onclick="removeFile(${file.id})"
                            class="text-red-500 hover:text-red-700 transition-colors"
                            title="Supprimer de la liste"
                        >
                            ‚ùå
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${new Date(file.timestamp).toLocaleString('fr-FR')}
                        ${file.size ? `‚Ä¢ ${formatFileSize(file.size)}` : ''}
                    </div>
                    <button
                        onclick="downloadFile('${file.name}')"
                        class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg"
                    >
                        üì• T√©l√©charger
                    </button>
                </div>
            `).join('');
            clearBtn.classList.remove('hidden');
        }
    }

    // Charger la liste au d√©marrage
    document.addEventListener('DOMContentLoaded', function() {
        loadFilesFromServer();
    });

    document.getElementById('genForm').onsubmit = async function (e) {
        e.preventDefault();
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        loading.classList.remove('hidden');
        loading.classList.add('flex');
        result.innerHTML = '';

        const form = e.target;
        const app_name = form.app_name.value.trim();
        const port = form.port.value.trim();
        const node_port = form.node_port.value.trim();
        const project_type = form.project_type.value;
        const simple = form.simple_or_k8s.value;
        const rows = document.querySelectorAll('#envContainer > div');
        const envs = [];

        rows.forEach(row => {
            const name = row.querySelector('input[name="env_name"]').value.trim();
            const value = row.querySelector('input[name="env_value"]').value.trim();
            const secret_id = row.querySelector('input[name="secret_id"]').value.trim();
            if (name) envs.push({name, value, secret_id});
        });

        try {
            await new Promise(resolve => setTimeout(resolve, 800));
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({app_name, port, node_port, envs, project_type, simple})
            });

            loading.classList.add('hidden');
            loading.classList.remove('flex');

            if (response.ok) {
                // T√©l√©charger le fichier ZIP
                const blob = await response.blob();
                const fileName = `${app_name}.zip`;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                // Recharger la liste des fichiers depuis le serveur
                setTimeout(() => {
                    loadFilesFromServer();
                }, 1000);

                // Afficher le message de succ√®s
                result.innerHTML = `
        <div class="mt-8 p-6 rounded-xl bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border border-green-200 flex items-center gap-3 opacity-0 translate-y-5 transition-all duration-400">
          <span class="text-xl">‚úÖ</span>
          <div>
            <strong>Succ√®s !</strong> Fichiers g√©n√©r√©s et t√©l√©charg√©s : <strong>${fileName}</strong>
          </div>
        </div>
      `;

                setTimeout(() => {
                    const resultContainer = result.querySelector('div');
                    if (resultContainer) {
                        resultContainer.classList.remove('opacity-0', 'translate-y-5');
                        resultContainer.classList.add('opacity-100', 'translate-y-0');
                    }
                }, 100);
            } else {
                const data = await response.json();
                result.innerHTML = `
        <div class="mt-8 p-6 rounded-xl bg-gradient-to-r from-red-100 to-pink-100 text-red-800 border border-red-200 flex items-center gap-3 opacity-0 translate-y-5 transition-all duration-400">
          <span class="text-xl">‚ùå</span>
          <div>
            <strong>Erreur :</strong> ${data.message}
          </div>
        </div>
      `;
                setTimeout(() => {
                    const resultContainer = result.querySelector('div');
                    if (resultContainer) {
                        resultContainer.classList.remove('opacity-0', 'translate-y-5');
                        resultContainer.classList.add('opacity-100', 'translate-y-0');
                    }
                }, 100);
            }
        } catch (error) {
            loading.classList.add('hidden');
            loading.classList.remove('flex');
            result.innerHTML = `
      <div class="mt-8 p-6 rounded-xl bg-gradient-to-r from-red-100 to-pink-100 text-red-800 border border-red-200 flex items-center gap-3">
        <span class="text-xl">‚ùå</span>
        <div>
          <strong>Erreur de connexion :</strong> Impossible de contacter le serveur
        </div>
      </div>
    `;
        }
    };

    // Animation de typing pour le placeholder
    const appNameInput = document.querySelector('input[name="app_name"]');
    const placeholders = ['mon-app-backend', 'api-users', 'service-auth', 'microservice-data', 'react-app', 'vue-frontend'];
    let currentIndex = 0;
    setInterval(() => {
        if (appNameInput.value === '' && appNameInput !== document.activeElement) {
            appNameInput.placeholder = placeholders[currentIndex];
            currentIndex = (currentIndex + 1) % placeholders.length;
        }
    }, 2000);
</script>
</body>
</html>